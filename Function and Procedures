-- Calculate the Total Amount -- Fucntion--

CREATE OR REPLACE FUNCTION Calculate_Total_Amount(customer_category VARCHAR, promotion_type VARCHAR, total_amount Number)
  RETURNS Number
  LANGUAGE SQL
  AS
  $$
    CASE 
        WHEN customer_category = 'Regular' AND promotion_type = 'Coupon_X' THEN total_amount - (total_amount * 0.03)
        WHEN customer_category = 'Regular' AND promotion_type = 'Coupon_Y' THEN total_amount - (total_amount * 0.02)
        WHEN customer_category = 'Regular' AND promotion_type = 'Coupon_Z' THEN total_amount - (total_amount * 0.01)
        WHEN customer_category = 'Gold' AND promotion_type = 'Discount' THEN total_amount - (total_amount * 5/100)
        WHEN customer_category = 'Silver' AND promotion_type = 'Discount' THEN total_amount - (total_amount * 3/100)
        WHEN customer_category = 'Bronze' AND promotion_type = 'Discount' THEN total_amount - (total_amount * 1/100)
        ELSE total_amount
    END
  $$;

        
--  Calculate the LOYALTY_POINTS --Function--

CREATE OR REPLACE FUNCTION Calculate_Loyalty_point(customer_category Varchar, PROMOTION_TYPE Varchar, total_amount Number, LOYALTY_POINTS Number)
  RETURNS Number
  LANGUAGE SQL
  AS
  $$
   CASE 
    WHEN total_amount > 1000 THEN
        CASE 
            WHEN customer_category = 'Gold' AND promotion_type = 'Loyalty' THEN LOYALTY_POINTS + 100
            WHEN customer_category = 'Silver' AND promotion_type = 'Loyalty' THEN LOYALTY_POINTS + 50
            WHEN customer_category = 'Bronze' AND promotion_type = 'Loyalty' THEN LOYALTY_POINTS + 30
            ELSE LOYALTY_POINTS
        END
    ELSE LOYALTY_POINTS
    END
  $$;
        

--  Update the Value for SOH, SOD, C , Invoice --PROCEDURE-- 

CREATE OR REPLACE PROCEDURE P_INVOICE_GENERATE()
RETURNS String
LANGUAGE SQL
AS
$$
BEGIN

    -- Update ITEM_COUNT in T_SALES_ORDER_HEADER --
    
    UPDATE T_SALES_ORDER_HEADER AS SOH
    SET ITEM_COUNT = (
        SELECT COUNT(SOD.ITEM_ID)
        FROM T_SALES_ORDER_DETAIL AS SOD
        WHERE SOD.ORDER_ID = SOH.ORDER_ID
        AND SOD.CUSTOMER_ID = SOH.CUSTOMER_ID
    );

    -- Update TOTAL_AMOUNT in T_SALES_ORDER_HEADER --
    
    UPDATE T_SALES_ORDER_HEADER AS SOH
    SET TOTAL_AMOUNT = (
        SELECT SUM(SOD.Total_Amount)
        FROM T_SALES_ORDER_DETAIL AS SOD
        WHERE SOD.ORDER_ID = SOH.ORDER_ID
        AND SOD.CUSTOMER_ID = SOH.CUSTOMER_ID
    );

     -- Update Discount in T_SALES_ORDER_HEADER --
     
    UPDATE T_SALES_ORDER_HEADER AS SOH
    SET DISCOUNT = ROUND(SOH.TOTAL_AMOUNT - Calculate_Total_Amount
        (C.CATEGORY, SOH.COUPON_CODE, SOH.TOTAL_AMOUNT), 2)
        FROM T_CUSTOMER AS C
        INNER JOIN T_PROMOTION AS P ON P.CUSTOMER_CATEGORY = C.CATEGORY
        WHERE SOH.COUPON_CODE = P.PROMOTION_TYPE;


    -- Update TOTAL_ORDER in T_CUSTOMER -- 
    
    UPDATE T_CUSTOMER AS C
    SET TOTAL_ORDERS = (
        SELECT COUNT(DISTINCT SOH.ORDER_ID)
        FROM T_SALES_ORDER_HEADER AS SOH
        WHERE C.CUSTOMER_ID = SOH.CUSTOMER_ID
    );


     -- Insert Final Invoice Fields into T_INVOICE --
     
    Insert into T_INVOICE(ORDER_ID, ORDER_DATE, INVOICE_DATE, TAX_AMOUNT, TOTAL_AMOUNT,DISCOUNT,FINAL_INVOICE_AMT,         CUSTOMER_ID, CREATE_DATE, CREATE_USER)
    SELECT DISTINCT
    SOH.ORDER_ID,
    SOH.ORDER_DATE,
    CURRENT_DATE AS INVOICE_DATE,
    Round((SOH.Total_Amount * 1.09) - SOH.Total_Amount, 2) AS TAX_AMOUNT,
    SOH.TOTAL_AMOUNT,
    SOH.DISCOUNT AS DISCOUNT,
    Round((SOH.TOTAL_AMOUNT - DISCOUNT) + SOH.Total_Amount * 0.09, 2) AS FINAL_INVOICE_AMT,
    C.CUSTOMER_ID,
    CURRENT_DATE AS CREATE_DATE,
    SOH.CREATE_USER 
FROM 
    T_CUSTOMER AS C
INNER JOIN 
    T_PROMOTION AS P ON P.CUSTOMER_CATEGORY = C.CATEGORY 
INNER JOIN 
    T_SALES_ORDER_HEADER AS SOH ON C.CUSTOMER_ID = SOH.CUSTOMER_ID
INNER JOIN 
    T_SALES_ORDER_DETAIL AS SOD ON SOD.ORDER_ID = SOH.ORDER_ID AND SOD.CUSTOMER_ID = SOH.CUSTOMER_ID
ORDER BY SOH.ORDER_ID;
    
   RETURN 'Item counts, total amounts, Total Orders and  updated successfully.';
END;
$$;

call P_INVOICE_GENERATE();
